#!/usr/bin/env python3
"""
modules/malware_signatures.py
Runs simple filename/content matching against signatures loaded from config.
"""
from pathlib import Path
import re
import json
import os

def run_once(verbose=False):
    findings = []
    sigs = []
    try:
        from modules.signatures import load_signatures
        sigs = load_signatures()
    except Exception:
        sigs = []

    # scan some common places lightly
    scan_paths = ["/data/local/tmp", "/sdcard", "/data/data"]
    for base in scan_paths:
        p = Path(base)
        if not p.exists():
            continue
        try:
            for child in p.rglob("*"):
                if not child.is_file():
                    continue
                name = child.name.lower()
                text = ""
                try:
                    # small files only
                    if child.stat().st_size < 200000:
                        text = child.read_text(errors="ignore").lower()
                except Exception:
                    pass
                for s in sigs:
                    pattern = s.get("pattern","").lower()
                    if pattern and (pattern in name or (pattern in text)):
                        findings.append({"type":"signature_match","signature":s.get("id"), "path":str(child)})
                        if verbose:
                            print("[malware_signatures] match", s.get("id"), "->", child)
        except Exception:
            continue

    return {"findings": findings}
